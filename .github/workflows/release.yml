name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Build all packages
      run: |
        make clean
        make
        make deb
        make rpm
        make arch

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          packaging/deb/*.deb
          packaging/rpm/*.rpm
          packaging/arch/*.pkg.tar.*
          netsnmp
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload to release
      run: |
        echo "Release created with packages:"
        ls -la packaging/deb/ packaging/rpm/ packaging/arch/

  notify:
    runs-on: ubuntu-latest
    needs: create-release
    if: success()
    
    steps:
    - name: Send notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#releases'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}