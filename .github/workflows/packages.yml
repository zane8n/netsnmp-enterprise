name: Package Build

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly builds

jobs:
  build-packages:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: [amd64, arm64]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup QEMU
      uses: docker/setup-qemu-action@v2
      with:
        platforms: arm64

    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Debian package
      uses: docker/build-push-action@v4
      with:
        context: .
        platforms: linux/${{ matrix.architecture }}
        tags: netsnmp-enterprise:latest
        outputs: type=local,dest=packaging/deb
        build-args: |
          ARCH=${{ matrix.architecture }}

    - name: Build RPM package
      run: |
        docker run --rm -v $(pwd):/src -w /src centos:8 \
          make rpm

    - name: Store artifacts
      uses: actions/upload-artifact@v3
      with:
        name: packages-${{ matrix.architecture }}
        path: |
          packaging/deb/*.deb
          packaging/rpm/*.rpm
          packaging/arch/*.pkg.tar.*

  deploy-test:
    runs-on: ubuntu-latest
    needs: build-packages
    environment: test
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: packages-amd64
        path: packages

    - name: Deploy to test environment
      run: |
        echo "Deploying packages to test environment..."
        # Add your deployment logic here
        ls -la packages/

    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        # Add your test deployment logic here